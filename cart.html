<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Shopping Cart | Adhyayana</title>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body{
  background:linear-gradient(135deg,#eef2ff,#f8fafc);
  padding:40px;
}
h2{
  margin-bottom:30px;
  font-size:28px;
  font-weight:800;
}
/* KEEPING YOUR FULL UI SAME */
.empty-wrapper{text-align:center;margin-top:120px;perspective:1000px;animation:fadeIn 1s ease;}
.empty-box{background:white;padding:50px;border-radius:30px;box-shadow:0 30px 60px rgba(0,0,0,0.08);display:inline-block;transform-style:preserve-3d;transition:0.6s;animation:floatBox 4s ease-in-out infinite;}
.empty-box:hover{transform:rotateX(6deg) rotateY(-6deg) scale(1.03);}
.empty-icon{font-size:60px;margin-bottom:20px;animation:spinIcon 6s linear infinite;}
.browse-btn{margin-top:25px;padding:16px 40px;font-size:16px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(90deg,#6366f1,#8b5cf6);color:white;transition:0.4s;box-shadow:0 15px 30px rgba(99,102,241,0.4);}
.browse-btn:hover{transform:translateY(-5px) scale(1.05);box-shadow:0 25px 45px rgba(99,102,241,0.6);}
.container{max-width:1250px;margin:auto;display:grid;grid-template-columns:2fr 1fr;gap:40px;}
.cart-card{background:white;padding:25px;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.06);}
.cart-item{display:flex;gap:20px;margin-bottom:25px;padding-bottom:25px;border-bottom:1px solid #e2e8f0;}
.cart-item img{width:170px;height:110px;object-fit:cover;border-radius:12px;}
.item-details{flex:1;}
.price{font-weight:700;margin:8px 0;font-size:16px;}
.qty-box{display:flex;align-items:center;gap:10px;margin-top:10px;}
.qty-box button{width:32px;height:32px;border:none;background:#e2e8f0;font-weight:800;cursor:pointer;border-radius:8px;}
.remove-btn{margin-top:12px;background:#ef4444;border:none;padding:8px 14px;color:white;border-radius:8px;cursor:pointer;}
.summary{background:white;padding:30px;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.06);position:sticky;top:40px;height:fit-content;}
.checkout-btn{width:100%;padding:16px;background:linear-gradient(90deg,#16a34a,#15803d);border:none;border-radius:12px;color:white;font-weight:700;cursor:pointer;margin-top:20px;font-size:16px;}
</style>
</head>

<body>

<h2>ðŸ›’ Your Shopping Cart</h2>
<div id="main"></div>

<script type="module">

import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import { getFirestore, doc, getDoc }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_KEY",
  authDomain: "login-65d4b.firebaseapp.com",
  projectId: "login-65d4b",
  storageBucket: "login-65d4b.appspot.com",
  messagingSenderId: "239979806578",
  appId: "1:239979806578:web:65db25b7e975ef0f1867eb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let cart = JSON.parse(localStorage.getItem("cart")) || [];
let currentUser = JSON.parse(localStorage.getItem("currentUser"));

renderCart();

async function renderCart(){

  if(cart.length===0){
    document.getElementById("main").innerHTML=`
      <div class="empty-wrapper">
        <div class="empty-box">
          <div class="empty-icon">ðŸ›’</div>
          <h2>Your cart feels lonely!</h2>
          <button class="browse-btn" onclick="window.location='market.html'">
            Browse Courses ðŸš€
          </button>
        </div>
      </div>
    `;
    return;
  }

  let total=0;
  let html=`<div class="container"><div class="cart-card">`;

  for(const item of cart){
    const snap = await getDoc(doc(db,"courses",item.id));

    if(snap.exists()){
      const course = snap.data();
      const price = Number(course.price || 0);
      const qty = item.qty || 1;
      const subtotal = price * qty;
      total += subtotal;

      let thumbnail = course.thumbnailUrl || "https://via.placeholder.com/300x170?text=Course";

      html+=`
        <div class="cart-item">
          <img src="${thumbnail}">
          <div class="item-details">
            <h3>${course.title}</h3>
            <div class="price">â‚¹ ${price}</div>

            <div class="qty-box">
              <button onclick="changeQty('${item.id}', -1)">-</button>
              <span>${qty}</span>
              <button onclick="changeQty('${item.id}', 1)">+</button>
            </div>

            <div>Subtotal: â‚¹ ${subtotal}</div>

            <button class="remove-btn" onclick="removeFromCart('${item.id}')">
              Remove
            </button>
          </div>
        </div>
      `;
    }
  }

  html+=`
      </div>
      <div class="summary">
        <h3>Order Summary</h3>
        <div>Total â‚¹ ${total}</div>
        <button class="checkout-btn" onclick="checkout(${total})">
          Secure Payment ðŸ”’
        </button>
      </div>
    </div>
  `;

  document.getElementById("main").innerHTML=html;
}

window.changeQty=function(id,change){
  cart=cart.map(item=>{
    if(item.id===id){
      item.qty=(item.qty||1)+change;
      if(item.qty<1)item.qty=1;
    }
    return item;
  });
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}

window.removeFromCart=function(id){
  cart=cart.filter(item=>item.id!==id);
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}

/* âœ… UPDATED PAYMENT SECTION ONLY */

window.checkout = async function(total){

  if(!currentUser){
    alert("Login first");
    window.location="login.html";
    return;
  }

  try{

    const res = await fetch("https://payment-backend-1-wobl.onrender.com/create-order",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        amount: total * 100   // convert â‚¹ to paise
      })
    });

    const data = await res.json();

    if(data.error){
      alert(data.error);
      return;
    }

    var options = {
      key: "rzp_test_SG54KSI2Pb6QzN",   // PUT YOUR KEY_ID ONLY
      amount: data.amount,
      currency: "INR",
      order_id: data.id,
      name: "Adhyayana",
      description: "Course Purchase",
      handler: function(response){
        localStorage.removeItem("cart");
        alert("Payment Successful ðŸŽ‰");
        window.location="dashboard.html";
      }
    };

    var rzp = new Razorpay(options);
    rzp.open();

  }catch(err){
    console.error(err);
    alert("Payment server error");
  }
}

</script>
</body>
</html>
