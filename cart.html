<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Shopping Cart | Adhyayana</title>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body{background:linear-gradient(135deg,#eef2ff,#f8fafc);padding:40px;}
h2{margin-bottom:30px;font-size:28px;font-weight:800;}
.empty-wrapper{text-align:center;margin-top:120px;}
.empty-box{background:white;padding:50px;border-radius:30px;box-shadow:0 30px 60px rgba(0,0,0,0.08);}
.empty-icon{font-size:60px;margin-bottom:20px;}
.browse-btn{margin-top:25px;padding:16px 40px;font-size:16px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(90deg,#6366f1,#8b5cf6);color:white;}
.container{max-width:1250px;margin:auto;display:grid;grid-template-columns:2fr 1fr;gap:40px;}
.cart-card{background:white;padding:25px;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.06);}
.cart-item{display:flex;gap:20px;margin-bottom:25px;padding-bottom:25px;border-bottom:1px solid #e2e8f0;}
.cart-item img{width:170px;height:110px;object-fit:cover;border-radius:12px;}
.item-details{flex:1;}
.price{font-weight:700;margin:8px 0;font-size:16px;}
.remove-btn{margin-top:12px;background:#ef4444;border:none;padding:8px 14px;color:white;border-radius:8px;cursor:pointer;}
.summary{background:white;padding:30px;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.06);position:sticky;top:40px;height:fit-content;}
.checkout-btn{width:100%;padding:16px;background:linear-gradient(90deg,#16a34a,#15803d);border:none;border-radius:12px;color:white;font-weight:700;cursor:pointer;margin-top:20px;font-size:16px;}
</style>
</head>

<body>

<h2>ðŸ›’ Your Shopping Cart</h2>
<div id="main"></div>

<script type="module">

import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import { 
  getFirestore, 
  doc, 
  getDoc,
  collection,
  addDoc,
  serverTimestamp
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { 
  getAuth, 
  onAuthStateChanged,
  setPersistence,
  browserLocalPersistence
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* ================= FIREBASE CONFIG ================= */

const firebaseConfig = {
  apiKey: "AIzaSyC0HLb1TVf3vJCQEQr2pUOonoXoKnjbrtw",
  authDomain: "login-65d4b.firebaseapp.com",
  projectId: "login-65d4b",
  storageBucket: "login-65d4b.appspot.com",
  messagingSenderId: "239979806578",
  appId: "1:239979806578:web:65db25b7e975ef0f1867eb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let firebaseUser = null;
let cart = JSON.parse(localStorage.getItem("cart")) || [];
const main = document.getElementById("main");

/* ================= FIX LOGIN PERSISTENCE ================= */

await setPersistence(auth, browserLocalPersistence);

/* ================= AUTH CHECK ================= */

onAuthStateChanged(auth, (user) => {

  if(user){
    firebaseUser = user;
    renderCart();
  }else{
    setTimeout(() => {
      if(!auth.currentUser){
        alert("Login first");
        window.location="login.html";
      }
    },1200);
  }

});

/* ================= RENDER CART ================= */

async function renderCart(){

  if(cart.length === 0){
    main.innerHTML = `
      <div class="empty-wrapper">
        <div class="empty-box">
          <div class="empty-icon">ðŸ›’</div>
          <h3>Your cart is empty</h3>
          <button class="browse-btn" onclick="window.location='market.html'">
            Browse Courses
          </button>
        </div>
      </div>
    `;
    return;
  }

  let total = 0;
  let html = `<div class="container">
                <div class="cart-card">`;

  for(let item of cart){

    const snap = await getDoc(doc(db,"courses",item.id));
    if(!snap.exists()) continue;

    const course = snap.data();
    total += Number(course.price);

    html += `
      <div class="cart-item">
        <img src="${course.thumbnail}" alt="">
        <div class="item-details">
          <h4>${course.title}</h4>
          <div class="price">â‚¹${course.price}</div>
          <button class="remove-btn" onclick="removeItem('${item.id}')">
            Remove
          </button>
        </div>
      </div>
    `;
  }

  html += `</div>

          <div class="summary">
            <h3>Order Summary</h3>
            <p style="margin-top:15px;font-weight:600;">
              Total: â‚¹${total}
            </p>
            <button class="checkout-btn" onclick="checkout(${total})">
              Proceed to Checkout
            </button>
          </div>
        </div>`;

  main.innerHTML = html;
}

/* ================= REMOVE ITEM ================= */

window.removeItem = function(id){
  cart = cart.filter(item => item.id !== id);
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

/* ================= CHECKOUT ================= */

window.checkout = async function(total){

  if(!firebaseUser){
    alert("Login first");
    window.location="login.html";
    return;
  }

  try{

    const res = await fetch("https://payment-backend-1-wobl.onrender.com/create-order",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ amount: total * 100 })
    });

    const data = await res.json();

    var options = {
      key: "rzp_test_SG54KSI2Pb6QzN",
      amount: data.amount,
      currency: "INR",
      order_id: data.id,
      name: "Adhyayana",
      description: "Course Purchase",

      handler: async function(){

        for(let item of cart){

          const snap = await getDoc(doc(db,"courses",item.id));
          if(!snap.exists()) continue;

          const course = snap.data();
          const amount = Number(course.price);

          await addDoc(collection(db,"purchases"),{
            courseId: item.id,
            teacherId: course.creatorId,
            studentId: firebaseUser.uid,
            amount: amount,
            teacherRevenue: amount * 0.8,
            platformRevenue: amount * 0.2,
            createdAt: serverTimestamp()
          });
        }

        localStorage.removeItem("cart");
        alert("Payment Successful ðŸŽ‰");
        window.location="dashboard.html";
      }
    };

    var rzp = new Razorpay(options);
    rzp.open();

  }catch(err){
    alert("Payment server error");
  }

}

</script>

</body>
</html>
