<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Shopping Cart | Adhyayana</title>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}

body{
  background:linear-gradient(135deg,#eef2ff,#f8fafc);
  padding:40px;
}

h2{
  margin-bottom:30px;
  font-size:28px;
  font-weight:800;
}

/* ================= EMPTY 3D ================= */

.empty-wrapper{
  text-align:center;
  margin-top:120px;
  perspective:1000px;
  animation:fadeIn 1s ease;
}

.empty-box{
  background:white;
  padding:50px;
  border-radius:30px;
  box-shadow:0 30px 60px rgba(0,0,0,0.08);
  display:inline-block;
  transform-style:preserve-3d;
  transition:0.6s;
  animation:floatBox 4s ease-in-out infinite;
}

.empty-box:hover{
  transform:rotateX(6deg) rotateY(-6deg) scale(1.03);
}

.empty-icon{
  font-size:60px;
  margin-bottom:20px;
  animation:spinIcon 6s linear infinite;
}

.browse-btn{
  margin-top:25px;
  padding:16px 40px;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:50px;
  cursor:pointer;
  background:linear-gradient(90deg,#6366f1,#8b5cf6);
  color:white;
  transition:0.4s;
  box-shadow:0 15px 30px rgba(99,102,241,0.4);
}

.browse-btn:hover{
  transform:translateY(-5px) scale(1.05);
  box-shadow:0 25px 45px rgba(99,102,241,0.6);
}

/* ================= CART ================= */

.container{
  max-width:1250px;
  margin:auto;
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:40px;
}

.cart-card{
  background:white;
  padding:25px;
  border-radius:20px;
  box-shadow:0 15px 40px rgba(0,0,0,0.06);
}

.cart-item{
  display:flex;
  gap:20px;
  margin-bottom:25px;
  padding-bottom:25px;
  border-bottom:1px solid #e2e8f0;
  transition:0.3s ease;
}

.cart-item:hover{
  transform:translateY(-4px);
}

.cart-item img{
  width:170px;
  height:110px;
  object-fit:cover;
  border-radius:12px;
}

.item-details{
  flex:1;
}

.item-details h3{
  margin-bottom:8px;
  font-size:18px;
}

.price{
  font-weight:700;
  margin:8px 0;
  font-size:16px;
}

.subtotal{
  color:#64748b;
  font-size:14px;
}

.qty-box{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
}

.qty-box button{
  width:32px;
  height:32px;
  border:none;
  background:#e2e8f0;
  font-weight:800;
  cursor:pointer;
  border-radius:8px;
  transition:0.2s;
}

.qty-box button:hover{
  background:#cbd5e1;
}

.remove-btn{
  margin-top:12px;
  background:#ef4444;
  border:none;
  padding:8px 14px;
  color:white;
  border-radius:8px;
  cursor:pointer;
  transition:0.3s;
}

.remove-btn:hover{
  background:#dc2626;
}

/* ================= SUMMARY ================= */

.summary{
  background:white;
  padding:30px;
  border-radius:20px;
  box-shadow:0 15px 40px rgba(0,0,0,0.06);
  position:sticky;
  top:40px;
  height:fit-content;
}

.summary h3{
  margin-bottom:20px;
  font-size:20px;
  font-weight:700;
}

.summary-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:12px;
  font-size:15px;
}

.total{
  font-size:18px;
  font-weight:800;
  margin-top:10px;
}

.checkout-btn{
  width:100%;
  padding:16px;
  background:linear-gradient(90deg,#16a34a,#15803d);
  border:none;
  border-radius:12px;
  color:white;
  font-weight:700;
  cursor:pointer;
  margin-top:20px;
  font-size:16px;
  transition:0.3s;
}

.checkout-btn:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 25px rgba(22,163,74,0.4);
}

/* ================= ANIMATION ================= */

@keyframes floatBox{
  0%{transform:translateY(0px);}
  50%{transform:translateY(-12px);}
  100%{transform:translateY(0px);}
}

@keyframes spinIcon{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(30px);}
  to{opacity:1;transform:translateY(0);}
}
</style>
</head>

<body>

<h2>ðŸ›’ Your Shopping Cart</h2>
<div id="main"></div>

<script type="module">

import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import { getFirestore, doc, getDoc }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0HLb1TVf3vJCQEQr2pUOonoXoKnjbrtw",
  authDomain: "login-65d4b.firebaseapp.com",
  projectId: "login-65d4b",
  storageBucket: "login-65d4b.appspot.com",
  messagingSenderId: "239979806578",
  appId: "1:239979806578:web:65db25b7e975ef0f1867eb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let cart = JSON.parse(localStorage.getItem("cart")) || [];
let currentUser = JSON.parse(localStorage.getItem("currentUser"));

renderCart();

async function renderCart(){

  if(cart.length===0){
    document.getElementById("main").innerHTML=`
      <div class="empty-wrapper">
        <div class="empty-box">
          <div class="empty-icon">ðŸ›’</div>
          <h2>Your cart feels lonely!</h2>
          <p style="color:#64748b;margin-top:10px;">
            Discover amazing courses and start learning today.
          </p>
          <button class="browse-btn" onclick="window.location='market.html'">
            Browse Courses ðŸš€
          </button>
        </div>
      </div>
    `;
    return;
  }

  let total=0;
  let html=`<div class="container"><div class="cart-card">`;

  for(const item of cart){

    const snap = await getDoc(doc(db,"courses",item.id));

    if(snap.exists()){
      const course = snap.data();
      const price = Number(course.price || 0);
      const qty = item.qty || 1;
      const subtotal = price * qty;
      total += subtotal;

      let thumbnail="";
      if(course.thumbnailUrl){
        thumbnail = course.thumbnailUrl;
      } else if(course.videoUrl){
        thumbnail = course.videoUrl.replace("/video/upload/","/video/upload/so_1/");
      } else {
        thumbnail = "https://via.placeholder.com/300x170?text=Course";
      }

      html+=`
        <div class="cart-item">
          <img src="${thumbnail}">
          <div class="item-details">
            <h3>${course.title}</h3>
            <div class="price">â‚¹ ${price}</div>

            <div class="qty-box">
              <button onclick="changeQty('${item.id}', -1)">-</button>
              <span>${qty}</span>
              <button onclick="changeQty('${item.id}', 1)">+</button>
            </div>

            <div class="subtotal">Subtotal: â‚¹ ${subtotal}</div>

            <button class="remove-btn" onclick="removeFromCart('${item.id}')">
              Remove
            </button>
          </div>
        </div>
      `;
    }
  }

  html+=`
      </div>

      <div class="summary">
        <h3>Order Summary</h3>

        <div class="summary-row">
          <span>Total</span>
          <span>â‚¹ ${total}</span>
        </div>

        <button class="checkout-btn" onclick="checkout(${total})">
          Secure Payment ðŸ”’
        </button>
      </div>
    </div>
  `;

  document.getElementById("main").innerHTML=html;
}

window.changeQty=function(id, change){
  cart = cart.map(item=>{
    if(item.id===id){
      item.qty = (item.qty || 1) + change;
      if(item.qty < 1) item.qty = 1;
    }
    return item;
  });
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}

window.removeFromCart=function(id){
  cart = cart.filter(item=>item.id!==id);
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}

window.checkout = async function(total){

  if(!currentUser){
    alert("Login first");
    window.location="login.html";
    return;
  }

  try{

    const courseId = cart[0].id;

    const res = await fetch("http://localhost:5000/create-order",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ courseId })
    });

    const data = await res.json();

    if(data.error){
      alert(data.error);
      return;
    }

    var options = {
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.orderId,
      name: "Adhyayana",
      description: "Course Purchase",

      handler: async function(response){

        await fetch("http://localhost:5000/verify-payment",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            paymentId: response.razorpay_payment_id,
            orderId: response.razorpay_order_id,
            signature: response.razorpay_signature,
            courseId: courseId
          })
        });

        localStorage.removeItem("cart");
        alert("Payment Successful ðŸŽ‰");
        window.location="dashboard.html";
      }
    };

    var rzp = new Razorpay(options);
    rzp.open();

  }catch(err){
    console.error(err);
    alert("Payment server error");
  }
}

</script>
</body>
</html>
