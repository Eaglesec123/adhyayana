<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard | Adhyayana</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#0f172a;
  color:white;
  display:flex;
}

.sidebar{
  width:240px;
  background:#111827;
  height:100vh;
  padding:20px;
}
.sidebar a{
  display:block;
  padding:12px;
  margin:10px 0;
  background:#1f2937;
  border-radius:8px;
  color:white;
  cursor:pointer;
}
.sidebar a:hover{background:#6366f1}

.main{
  flex:1;
  padding:40px;
}

.upload-card{
  max-width:600px;
  background:#1f2937;
  padding:30px;
  border-radius:15px;
}

.upload-card input,
.upload-card textarea{
  width:100%;
  padding:10px;
  margin:10px 0;
  border-radius:6px;
  border:none;
}

.preview-img{
  width:100%;
  height:180px;
  object-fit:cover;
  border-radius:8px;
  margin-top:10px;
}

.preview-video{
  width:100%;
  margin-top:10px;
  border-radius:8px;
}

.progress{
  height:6px;
  background:#0f172a;
  border-radius:6px;
  margin-top:8px;
}
.bar{
  height:100%;
  width:0%;
  background:#22c55e;
  transition:.3s;
}

button{
  padding:10px 15px;
  background:#6366f1;
  border:none;
  color:white;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="sidebar">
  <a>ðŸ“š Upload Course</a>
</div>

<div class="main">

<h2>Upload Course (Image + Video)</h2>

<div class="upload-card">

<input type="text" id="courseTitle" placeholder="Course Title">
<input type="number" id="coursePrice" placeholder="Course Price">

<label>Thumbnail Image</label>
<input type="file" id="thumbFile" accept="image/*">
<img id="thumbPreview" class="preview-img" style="display:none;">
<div class="progress"><div id="thumbBar" class="bar"></div></div>

<label>Course Video</label>
<input type="file" id="videoFile" accept="video/*">
<video id="videoPreview" controls class="preview-video" style="display:none;"></video>
<div class="progress"><div id="videoBar" class="bar"></div></div>

<textarea id="courseDesc" placeholder="Course Description"></textarea>

<button onclick="uploadCourse()">Upload Course</button>

</div>

</div>

<script type="module">

import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import { getAuth } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { getFirestore, collection, addDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { getStorage, ref, uploadBytesResumable, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";


/* ================= FIREBASE CONFIG ================= */

const firebaseConfig = {
  apiKey: "AIzaSyC0HLb1TVf3vJCQEQr2pUOonoXoKnjbrtw",
  authDomain: "login-65d4b.firebaseapp.com",
  projectId: "login-65d4b",
  storageBucket: "login-65d4b.appspot.com",
  messagingSenderId: "239979806578",
  appId: "1:239979806578:web:65db25b7e975ef0f1867eb",
  measurementId: "G-3GT10B4SYM"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);


/* ================= CLOUDINARY CONFIG ================= */

const CLOUD_NAME = "dlqbfsh92";
const UPLOAD_PRESET = "darshan";


/* ================= PREVIEW IMAGE ================= */

document.getElementById("thumbFile").addEventListener("change", function(){
  const file=this.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=function(e){
      const img=document.getElementById("thumbPreview");
      img.src=e.target.result;
      img.style.display="block";
    }
    reader.readAsDataURL(file);
  }
});


/* ================= PREVIEW VIDEO ================= */

document.getElementById("videoFile").addEventListener("change", function(){
  const file=this.files[0];
  if(file){
    const video=document.getElementById("videoPreview");
    video.src=URL.createObjectURL(file);
    video.style.display="block";
  }
});


/* ================= UPLOAD FUNCTION ================= */

window.uploadCourse = async function(){

  const title=document.getElementById("courseTitle").value;
  const price=document.getElementById("coursePrice").value;
  const thumb=document.getElementById("thumbFile").files[0];
  const video=document.getElementById("videoFile").files[0];
  const desc=document.getElementById("courseDesc").value;

  if(!title || !price || !thumb || !video){
    return alert("Fill all fields");
  }

  /* ==== Upload Thumbnail to Cloudinary ==== */

  const formData = new FormData();
  formData.append("file", thumb);
  formData.append("upload_preset", UPLOAD_PRESET);

  const cloudRes = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    {
      method: "POST",
      body: formData
    }
  );

  const cloudData = await cloudRes.json();
  const thumbURL = cloudData.secure_url;

  document.getElementById("thumbBar").style.width="100%";


  /* ==== Upload Video to Firebase ==== */

  const videoRef=ref(storage,'videos/'+Date.now()+video.name);
  const videoTask=uploadBytesResumable(videoRef,video);

  videoTask.on('state_changed',(snap)=>{
    const progress=(snap.bytesTransferred/snap.totalBytes)*100;
    document.getElementById("videoBar").style.width=progress+"%";
  },null,async()=>{

    const videoURL=await getDownloadURL(videoTask.snapshot.ref);

    await addDoc(collection(db,"courses"),{
      title,
      price:Number(price),
      thumbnail:thumbURL,
      videoURL:videoURL,
      description:desc,
      createdAt:new Date()
    });

    alert("Course Uploaded Successfully ðŸš€");

    document.getElementById("thumbBar").style.width="0%";
    document.getElementById("videoBar").style.width="0%";

  });

};

</script>

</body>
</html>
